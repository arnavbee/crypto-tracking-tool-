<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Tracking Tool</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background-color: #f0f0f0;
            color: #333;
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 30px;
        }
        #visualization-container { 
            width: 100%;
            max-width: 800px;
            margin: 20px 0;
        }
        #timeSlider { 
            width: 100%;
            max-width: 800px;
            margin: 20px 0;
        }
        input, button {
            margin: 10px;
            padding: 10px;
            font-size: 16px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        #transactionDetails { 
            position: fixed; 
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white; 
            border: 1px solid black; 
            padding: 10px; 
            display: none;
            max-height: 80vh;
            max-width: 80vw;
            width: 400px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }
        #closeDetails {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            font-size: 20px;
        }
        .transaction-link {
            color: #3498db;
            text-decoration: none;
        }
        .transaction-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <h1>Crypto Tracking Tool</h1>
    
    <div>
        <input type="text" id="addressInput" placeholder="Enter Ethereum address">
        <button id="trackButton">Track Address</button>
    </div>

    <div>
        <input type="date" id="startDate">
        <input type="date" id="endDate">
        <button id="filterButton">Filter by Date</button>
    </div>
    <input type="range" id="timeSlider" min="0" max="100" value="100">
    <div id="transactionDetails">
        <span id="closeDetails">&times;</span>
        <div id="detailsContent"></div>
    </div>
    <div id="visualization-container"></div>

    <script>
        const API_KEY = 'VIZPYJ1P5MZEKPFX9KFQV8TKB949ZN2YZT';

        function weiToEther(wei) {
            return wei / 1e18;
        }

        async function fetchTransactions(address) {
            try {
                const response = await fetch(`https://api.etherscan.io/api?module=account&action=txlist&address=${address}&startblock=0&endblock=99999999&page=1&offset=100&sort=desc&apikey=${API_KEY}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                console.log('API Response:', data); // Log the full API response

                if (data.status === '1' && data.result.length > 0) {
                    allTransactions = data.result.map(tx => ({
                        from: tx.from,
                        to: tx.to,
                        hash: tx.hash,
                        value: weiToEther(parseFloat(tx.value)),
                        timestamp: new Date(tx.timeStamp * 1000)
                    }));
                    
                    console.log('Fetched transactions:', allTransactions);
                    
                    visualizeTrail(allTransactions, address);
                } else {
                    console.error('API Response Error:', data.message || 'Unknown error');
                    alert(`No transactions found or error in API response: ${data.message || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error fetching transactions:', error);
                alert(`Error fetching transactions: ${error.message}`);
            }
        }

        function visualizeTrail(transactions, centerAddress) {
            console.log('Visualizing transactions:', transactions);

            // Clear any existing SVG content
            d3.select('#visualization-container').html('');

            const width = 800;
            const height = 600;

            const svg = d3.select('#visualization-container').append('svg')
                .attr('width', width)
                .attr('height', height)
                .style('border', '1px solid black');

            // Create nodes for unique addresses
            const nodes = Array.from(new Set(transactions.flatMap(t => [t.from, t.to])))
                .map(address => ({ id: address, group: address === centerAddress ? 1 : 2 }));

            // Create links from transactions
            const links = transactions.map(t => ({ source: t.from, target: t.to, hash: t.hash, value: t.value }));

            // Create a force simulation
            const simulation = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(links).id(d => d.id))
                .force('charge', d3.forceManyBody().strength(-500))
                .force('center', d3.forceCenter(width / 2, height / 2));

            // Add zoom behavior
            const zoom = d3.zoom()
                .scaleExtent([0.1, 10])
                .on('zoom', (event) => {
                    svg.attr('transform', event.transform);
                });

            svg.call(zoom);

            // Add links to SVG
            const link = svg.append('g')
                .selectAll('line')
                .data(links)
                .enter().append('line')
                .attr('stroke', '#999')
                .attr('stroke-opacity', 0.6);

            // Update node creation to show transaction value
            const node = svg.append('g')
                .selectAll('circle')
                .data(nodes)
                .enter().append('circle')
                .attr('r', d => {
                    const nodeTransactions = links.filter(l => l.source.id === d.id || l.target.id === d.id);
                    const totalValue = nodeTransactions.reduce((sum, t) => sum + t.value, 0);
                    return Math.max(5, Math.min(20, Math.log(totalValue + 1) * 2));
                })
                .attr('fill', d => d.group === 1 ? '#ff0000' : '#00f')
                .on('click', function(event, d) {
                    showTransactionDetails(d, event);
                })
                .on('mouseover', function(event, d) {
                    d3.select(this).attr('stroke', 'black').attr('stroke-width', 2);
                })
                .on('mouseout', function(event, d) {
                    d3.select(this).attr('stroke', null);
                });

            // Add labels to nodes
            const label = svg.append('g')
                .selectAll('text')
                .data(nodes)
                .enter().append('text')
                .text(d => d.id.slice(0, 6) + '...')
                .attr('font-size', 10)
                .attr('dx', 12)
                .attr('dy', 4);

            // Update positions on each tick of the simulation
            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                node
                    .attr('cx', d => d.x)
                    .attr('cy', d => d.y);

                label
                    .attr('x', d => d.x)
                    .attr('y', d => d.y);
            });
        }

        function showTransactionDetails(node, event) {
            const nodeTransactions = allTransactions.filter(t => t.from.toLowerCase() === node.id.toLowerCase() || t.to.toLowerCase() === node.id.toLowerCase());
            const detailsContent = document.getElementById('detailsContent');
            
            let transactionList = nodeTransactions.slice(0, 10).map(t => `
                <li>
                    ${t.value.toFixed(4)} ETH 
                    ${t.from.toLowerCase() === node.id.toLowerCase() ? 'to' : 'from'} 
                    ${t.from.toLowerCase() === node.id.toLowerCase() ? t.to : t.from}
                    <a href="https://etherscan.io/tx/${t.hash}" class="transaction-link" target="_blank" rel="noopener noreferrer">View on Etherscan</a>
                </li>
            `).join('');

            detailsContent.innerHTML = `
                <h3>Address: ${node.id}</h3>
                <p>
                    <a href="https://etherscan.io/address/${node.id}" class="transaction-link" target="_blank" rel="noopener noreferrer">View Address on Etherscan</a>
                </p>
                <p>Total Transactions: ${nodeTransactions.length}</p>
                <p>Total Ether: ${nodeTransactions.reduce((sum, t) => sum + t.value, 0).toFixed(4)} ETH</p>
                <h4>Recent Transactions (up to 10):</h4>
                <ul>${transactionList}</ul>
            `;
            
            document.getElementById('transactionDetails').style.display = 'block';
        }

        document.getElementById('closeDetails').addEventListener('click', () => {
            document.getElementById('transactionDetails').style.display = 'none';
        });

        document.getElementById('trackButton').addEventListener('click', () => {
            const address = document.getElementById('addressInput').value;
            if (address) {
                fetchTransactions(address);
            } else {
                alert('Please enter an Ethereum address');
            }
        });

        document.getElementById('filterButton').addEventListener('click', () => {
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            const filteredTransactions = allTransactions.filter(t => 
                t.timestamp >= startDate && t.timestamp <= endDate
            );
            visualizeTrail(filteredTransactions, document.getElementById('addressInput').value);
        });

        document.getElementById('timeSlider').addEventListener('input', (event) => {
            const percentage = event.target.value;
            console.log(`Slider value: ${percentage}`);
        });
    </script>
</body>
</html>